name: Generate ALL Filter Formats (Adblock and Hosts)

# Action akan dijalankan jika ada perubahan di folder 'filters/'
on:
  push:
    paths:
      - 'filters/**'  # Monitor semua perubahan di dalam direktori 'filters'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Persiapkan direktori output untuk kedua format
      - name: Setup Output Directories
        run: |
          mkdir -p filters/output
          mkdir -p filters/output/host # Direktori baru untuk format Hosts

      - name: Combine ALL Lists and Convert Formats
        run: |
          echo "Mulai: Menggabungkan dan mengkonversi SEMUA (20+) file sumber..."
          
          # Definisikan SEMUA path file sumber (Daftar 20+ file dari request kamu)
          SOURCE_FILES=(
              "filters/blocklist/RifqyShield-BlockList.txt"
              "filters/blocklist/google-ads.txt"
              "filters/blocklist/blocklist.txt"
              "filters/blocklist/ads-xiaomi.txt"
              "filters/blocklist/ads-oppo-realme.txt"
              "filters/blocklist/ads-vivo.txt"
              "filters/blocklist/ads-huawei.txt"
              "filters/blocklist/ads-samsung.txt"
              "filters/youtube-ads/youtube-ads.txt"
              "filters/youtube-ads/youtube-ads2.txt"
              "filters/spotify-ads/spotify-ads.txt"
              "filters/spotify-ads/spotify-ads2.txt"
              "filters/nsfw/nsfw.txt"
              "filters/nsfw/nsfw-2.txt"
              "filters/nsfw/nsfw-3.txt"
              "filters/gambling/gambling.txt"
              "filters/gambling/gambling-2.txt"
              "filters/gambling/gambling-3.txt"
              "filters/blocklist/multi.txt.txt"
          )
          
          # 1. Gabungkan semua file ke dalam file sementara
          > combined_raw.tmp
          for file in "${SOURCE_FILES[@]}"; do
              if [ -f "$file" ]; then
                  echo "--> Menggabungkan file: $file"
                  cat "$file" >> combined_raw.tmp
              else
                  # Opsional: Jika kamu yakin semua file harus ada, ganti ini dengan 'exit 1'
                  echo "Peringatan: File $file tidak ditemukan, dilewati."
              fi
          done

          if ! grep -q "^0.0.0.0" combined_raw.tmp; then
            echo "ERROR: Tidak ada baris '0.0.0.0' yang valid ditemukan. Proses dihentikan."
            rm combined_raw.tmp
            exit 1
          fi

          echo "Memulai konversi ke dua format..."

          # --- FORMAT 1: HOSTS FILE (0.0.0.0 domain.com) ---
          # Ini adalah permintaan baru kamu: 0.0.0.0 web, di output/host/domain
          grep "^0.0.0.0" combined_raw.tmp | \
          tr -d '\r' | \
          sort | uniq > filters/output/host/domain
          echo "✅ Sukses: File hosts dibuat di filters/output/host/domain"

          # --- FORMAT 2: ADBLOCK FILE (||domain.com^) ---
          # Ini adalah format Adblock yang sudah kita buat sebelumnya, tetap dipertahankan
          grep "^0.0.0.0" combined_raw.tmp | \
          sed 's/0.0.0.0 /||/' | \
          sed 's/$/^/' | \
          tr -d '\r' | \
          sort | uniq > filters/output/domains.txt
          echo "✅ Sukses: File Adblock dibuat di filters/output/domains.txt"

          # Bersihkan file sementara
          rm combined_raw.tmp

      - name: Commit and Push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-update: Generated Hosts (output/host/domain) and Adblock (output/domains.txt)"
          # Commit kedua file output baru
          file_pattern: filters/output/** branch: ${{ github.ref }}
          
