name: Consolidated Filter Generator (FINAL - All Domains)

# Action dijalankan jika ada perubahan di folder 'filters/'
on:
  push:
    paths:
      - 'filters/**'  # Monitor semua perubahan di dalam direktori 'filters'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1. Setup Direktori Output yang Diperlukan (filters/output/blocklist)
      - name: Setup Output Directories
        run: |
          # Membuat folder output baru secara rekursif
          mkdir -p filters/output/blocklist

      - name: Combine ALL Sources and Convert to Single Plain Domain List
        run: |
          echo "Mulai: Menggabungkan dan mengkonversi SEMUA file sumber ke Domain Polos..."
          
          # --- DAFTAR FILE SUMBER YANG AKAN DISINKRONISASI ---
          SOURCE_FILES=(
              "filters/blocklist/RifqyShield-BlockList.txt"
              "filters/blocklist/google-ads.txt"
              "filters/blocklist/blocklist.txt"
              "filters/blocklist/ads-xiaomi.txt"
              "filters/blocklist/ads-oppo-realme.txt"
              "filters/blocklist/ads-vivo.txt"
              "filters/blocklist/ads-huawei.txt"
              "filters/blocklist/ads-samsung.txt"
              "filters/youtube-ads/youtube-ads.txt"
              "filters/youtube-ads/youtube-ads2.txt"
              "filters/spotify-ads/spotify-ads.txt"
              "filters/spotify-ads/spotify-ads2.txt"
              "filters/nsfw/nsfw.txt"
              "filters/nsfw/nsfw-2.txt"
              "filters/nsfw/nsfw-3.txt"
              "filters/gambling/gambling.txt"
              "filters/gambling/gambling-2.txt"
              "filters/gambling/gambling-3.txt"
              "filters/blocklist/multi.txt.txt"
          )
          
          # 2. Gabungkan semua data dari semua file sumber ke dalam file sementara
          > combined_raw.tmp
          for file in "${SOURCE_FILES[@]}"; do
              if [ -f "$file" ]; then
                  echo "--> Menggabungkan: $file"
                  cat "$file" >> combined_raw.tmp
              else
                  echo "Peringatan: File $file tidak ditemukan, dilewati."
              fi
          done

          # Cek jika ada data 0.0.0.0 yang valid
          if ! grep -q "^0.0.0.0" combined_raw.tmp; then
            echo "Peringatan: Tidak ada baris '0.0.0.0' yang valid ditemukan. Membuat file output kosong."
            rm combined_raw.tmp
            > filters/output/blocklist/all-domains.txt # Pastikan file tetap dibuat (kosong)
            exit 0
          fi

          echo "Memproses konversi ke format Domain Polos..."

          # 3. Konversi ke Format Domain Polos, Sortir, dan Hapus Duplikat
          # Menghapus "0.0.0.0 " dan mempertahankan domain
          grep "^0.0.0.0" combined_raw.tmp | \
          sed 's/0.0.0.0 //' | \
          tr -d '\r' | \
          sort | uniq > filters/output/blocklist/all-domains.txt

          echo "âœ… Sukses! File filters/output/blocklist/all-domains.txt (Domain Polos) telah dibuat."

          # Bersihkan file sementara
          rm combined_raw.tmp

      - name: Commit and Push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-update: Consolidated ALL sources into single plain domain list (all-domains.txt)"
          # Hanya commit file output yang baru
          file_pattern: filters/output/blocklist/all-domains.txt
          branch: ${{ github.ref }}
