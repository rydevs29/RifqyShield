name: Generate Final Adblock Filter (FIXED)

# Action akan dijalankan jika ada perubahan di folder 'filters/'
on:
  push:
    paths:
      - 'filters/**'  # Monitor semua perubahan di dalam direktori 'filters'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Output Directory
        run: mkdir -p filters/output

      - name: Combine ALL Lists and Convert to Adblock Format
        run: |
          echo "Mulai: Menggabungkan dan mengkonversi SEMUA (20+) file sumber..."
          
          # Definisikan SEMUA path file sumber
          SOURCE_FILES=(
              "filters/blocklist/RifqyShield-BlockList.txt"
              "filters/blocklist/google-ads.txt"
              "filters/blocklist/blocklist.txt"
              "filters/blocklist/ads-xiaomi.txt"
              "filters/blocklist/ads-oppo-realme.txt"
              "filters/blocklist/ads-vivo.txt"
              "filters/blocklist/ads-huawei.txt"
              "filters/blocklist/ads-samsung.txt"
              "filters/youtube-ads/youtube-ads.txt"
              "filters/youtube-ads/youtube-ads2.txt"
              "filters/spotify-ads/spotify-ads.txt"
              "filters/spotify-ads/spotify-ads2.txt"
              "filters/nsfw/nsfw.txt"
              "filters/nsfw/nsfw-2.txt"
              "filters/nsfw/nsfw-3.txt"
              "filters/gambling/gambling.txt"
              "filters/gambling/gambling-2.txt"
              "filters/gambling/gambling-3.txt"
              "filters/blocklist/multi.txt.txt"
          )
          
          # 1. Gabungkan semua file yang ada ke dalam satu file sementara
          > combined_raw.tmp
          for file in "${SOURCE_FILES[@]}"; do
              if [ -f "$file" ]; then
                  echo "--> Menggabungkan file: $file"
                  cat "$file" >> combined_raw.tmp
              else
                  echo "Peringatan: File $file tidak ditemukan, dilewati."
              fi
          done

          # 2. Periksa apakah ada data hosts (0.0.0.0) yang ditemukan
          if ! grep -q "^0.0.0.0" combined_raw.tmp; then
            echo "ERROR: Tidak ada baris '0.0.0.0' yang valid ditemukan di semua file sumber."
            rm combined_raw.tmp
            exit 1
          fi

          echo "Memproses konversi ke format Adblock (||domain.com^)..."

          # 3. Konversi ke format Adblock, sortir, dan buang duplikat
          grep "^0.0.0.0" combined_raw.tmp | \
          sed 's/0.0.0.0 /||/' | \
          sed 's/$/^/' | \
          tr -d '\r' | \
          sort | uniq > filters/output/domains.txt

          echo "âœ… Sukses! File filters/output/domains.txt (Adblock Only) telah dibuat."

          # Bersihkan file sementara
          rm combined_raw.tmp

      - name: Commit and Push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-update: FIXED - Consolidated ALL sources into single Adblock list (domains.txt)"
          file_pattern: filters/output/domains.txt
          branch: ${{ github.ref }}
